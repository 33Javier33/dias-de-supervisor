<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Trabajo Avanzado</title>
    <style>
        /* --- Tema Claro (Predeterminado) y Variables Globales --- */
        :root {
            --bg-color: #f0f2f5;
            --container-bg: #ffffff;
            --text-color: #333;
            --text-color-secondary: #555;
            --text-color-muted: #6a7c8d;
            --border-color: #e0e6ed;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --header-text-color: #2c3e50;
            --button-bg: #007bff;
            --button-hover-bg: #0056b3;
            --button-text-color: #ffffff;
            --report-btn-bg: #28a745;
            --report-btn-hover-bg: #218838;
            --data-btn-bg: #6c757d;
            --data-btn-hover-bg: #5a6268;
            --day-default-bg: #fdfefe;
            --day-default-border: #e9edf2;
            --day-today-border: #007bff;
            --status-supervisor-bg: #e0f2f7;
            --status-supervisor-border: #b3e0ed;
            --status-supervisor-text: #005f73;
            --status-crupier-bg: #e6ffe6;
            --status-crupier-border: #b3f0b3;
            --status-crupier-text: #2d6b3d;
            --input-bg: #f8f9fa;
            --input-border: #ced4da;
            --report-output-bg: #e9ecef;
            --modal-overlay-bg: rgba(0, 0, 0, 0.5);
            --note-indicator-color: #007bff;
        }

        /* --- Tema Oscuro --- */
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --text-color-secondary: #b0b0b0;
            --text-color-muted: #888888;
            --border-color: #3a3a3a;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --header-text-color: #ffffff;
            --day-default-bg: #2c2c2c;
            --day-default-border: #3a3a3a;
            --day-today-border: #4dabf7;
            --status-supervisor-bg: #003f5c;
            --status-supervisor-border: #005f73;
            --status-supervisor-text: #a7d8e8;
            --status-crupier-bg: #1e4620;
            --status-crupier-border: #2d6b3d;
            --status-crupier-text: #b3f0b3;
            --input-bg: #333333;
            --input-border: #555555;
            --report-output-bg: #252525;
            --modal-overlay-bg: rgba(0, 0, 0, 0.7);
            --note-indicator-color: #4dabf7;
        }

        /* --- Estilos Generales --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center;
            min-height: 100vh; background-color: var(--bg-color); color: var(--text-color);
            padding: 20px; margin: 0; box-sizing: border-box; transition: background-color 0.3s, color 0.3s;
        }

        /* --- Contenedores Principales --- */
        .container-box {
            background-color: var(--container-bg); border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color); padding: 25px;
            width: 100%; max-width: 580px; min-width: 320px;
            box-sizing: border-box; transition: background-color 0.3s; margin-bottom: 20px;
        }
        .container-box h3 {
            margin-top: 0; color: var(--header-text-color); font-size: 1.5em; margin-bottom: 15px; text-align: center;
        }

        /* --- Encabezado --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header h2 { margin: 0; font-size: 2em; color: var(--header-text-color); text-align: center; flex-grow: 1; }
        .header button {
            background-color: var(--button-bg); color: var(--button-text-color); border: none; padding: 10px 18px;
            border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s ease; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .header button:hover { background-color: var(--button-hover-bg); transform: translateY(-1px); }
        #themeToggle { background-color: transparent; font-size: 1.5em; padding: 5px 10px; box-shadow: none; color: var(--text-color); order: -1; }

        /* --- Calendario --- */
        .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); font-weight: bold; color: var(--text-color-muted); text-align: center; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); margin-bottom: 10px; }
        .day-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; transition: opacity 0.2s ease-in-out; }
        .day {
            border: 2px solid var(--day-default-border); border-radius: 8px; padding-bottom: 100%;
            position: relative; cursor: pointer; transition: all 0.2s ease;
        }
        .day:hover { transform: translateY(-2px); box-shadow: 0 4px 10px var(--shadow-color); }
        .day.today { border-color: var(--day-today-border); }
        .day-content {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex;
            flex-direction: column; justify-content: space-between; align-items: center; padding: 8px 4px; box-sizing: border-box;
        }
        .day .day-number { font-size: 1.3em; font-weight: bold; color: var(--text-color); }
        .day .status-text { font-size: 0.8em; font-weight: 600; color: var(--text-color-secondary); text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-indicator {
            width: 6px; height: 6px; background-color: var(--note-indicator-color); border-radius: 50%;
            position: absolute; top: 5px; right: 5px; display: none;
        }
        .day.has-note .note-indicator { display: block; }
        .status-libre { background-color: var(--day-default-bg); border-color: var(--day-default-border); }
        .status-libre.today { border-color: var(--day-today-border); }
        .status-supervisor { background-color: var(--status-supervisor-bg); border-color: var(--status-supervisor-border) !important; }
        .status-supervisor .status-text, .status-supervisor .day-number { color: var(--status-supervisor-text); }
        .status-crupier { background-color: var(--status-crupier-bg); border-color: var(--status-crupier-border) !important; }
        .status-crupier .status-text, .status-crupier .day-number { color: var(--status-crupier-text); }
        #supervisor-counter { text-align: center; margin-top: 15px; font-weight: bold; color: var(--text-color-secondary); }

        /* --- Sección de Informe --- */
        .report-controls { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 15px; }
        .report-controls .control-group { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px; width: 100%; }
        .report-controls label { font-size: 0.95em; color: var(--text-color-secondary); }
        .report-controls select, .report-controls input[type="number"] { padding: 8px; border: 1px solid var(--input-border); border-radius: 5px; font-size: 1em; background-color: var(--input-bg); color: var(--text-color); }
        .report-controls input[type="number"] { width: 80px; text-align: center; }
        #generateReportBtn { background-color: var(--report-btn-bg); margin-top: 10px; }
        #generateReportBtn:hover { background-color: var(--report-btn-hover-bg); }
        .report-output {
            background-color: var(--report-output-bg); border: 1px solid var(--input-border); color: var(--text-color);
            border-radius: 8px; padding: 15px; text-align: left; white-space: pre-wrap; word-wrap: break-word;
            font-family: monospace; font-size: 0.9em; min-height: 50px; max-height: 200px;
            overflow-y: auto; margin-top: 15px; cursor: text;
        }

        /* --- Sección de Estadísticas (Colapsable) --- */
        .stats-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px;}
        .stats-header h3 { margin-bottom: 0; }
        .stats-header .toggle-icon { font-size: 1.8em; font-weight: bold; transition: transform 0.3s ease; }
        .stats-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, opacity 0.4s ease-out, margin-top 0.4s ease-out; opacity: 0; }
        .stats-content.expanded { max-height: 600px; opacity: 1; margin-top: 15px; }
        .stats-controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 15px; }
        .stats-controls label { font-weight: bold; }
        .stats-controls select { padding: 8px; border: 1px solid var(--input-border); border-radius: 5px; background-color: var(--input-bg); color: var(--text-color); }
        #stats-results table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #stats-results th, #stats-results td { padding: 10px; border: 1px solid var(--border-color); text-align: center; }
        #stats-results th { background-color: var(--day-default-bg); }
        #stats-results .total-row { font-weight: bold; }

        /* --- Modal de Notas --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay-bg);
            display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: var(--container-bg); padding: 25px; border-radius: 12px;
            width: 90%; max-width: 400px; box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content { transform: scale(1); }
        #modal-date { margin: 0 0 15px 0; font-size: 1.5em; text-align: center; color: var(--header-text-color); }
        #modal-status { padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 15px; cursor: pointer; user-select: none; transition: background-color 0.2s; }
        #modal-note {
            width: 100%; height: 100px; padding: 10px; border: 1px solid var(--input-border);
            border-radius: 8px; background-color: var(--input-bg); color: var(--text-color);
            font-family: inherit; font-size: 1em; resize: vertical; margin-bottom: 15px; box-sizing: border-box;
        }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; }
        #modal-save { background-color: var(--report-btn-bg); }
        #modal-save:hover { background-color: var(--report-btn-hover-bg); }
        #modal-cancel { background-color: var(--data-btn-bg); }
        #modal-cancel:hover { background-color: var(--data-btn-hover-bg); }
        
        /* Botones y notificaciones */
        .data-buttons { display: flex; justify-content: center; gap: 15px; }
        .data-buttons button, .modal-buttons button, #generateReportBtn { color: var(--button-text-color); border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background-color 0.3s ease, transform 0.1s ease; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); padding: 12px 20px; font-size: 1em; }
        .data-buttons button:hover, .modal-buttons button:hover, #generateReportBtn:hover { transform: translateY(-1px); }
        .data-buttons button { background-color: var(--data-btn-bg); }
        .data-buttons button:hover { background-color: var(--data-btn-hover-bg); }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .toast { background-color: #2c3e50; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); font-size: 0.95em; opacity: 0; transform: translateX(100%); transition: opacity 0.5s ease, transform 0.5s ease; }
        .toast.show { opacity: 1; transform: translateX(0); }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div class="container-box">
        <div class="header">
            <button id="themeToggle">🌙</button>
            <button id="prevMonth">&lt;</button>
            <h2 id="monthYear"></h2>
            <button id="nextMonth">&gt;</button>
        </div>
        <div class="weekdays">
            <span>Lun</span><span>Mar</span><span>Mié</span><span>Jue</span><span>Vie</span><span>Sáb</span><span>Dom</span>
        </div>
        <div id="calendarGrid" class="day-grid"></div>
        <div id="supervisor-counter"></div>
    </div>

    <div class="container-box">
        <h3>Gestión de Datos</h3>
        <div class="data-buttons">
            <button id="importDataBtn">Importar Datos</button>
            <button id="exportDataBtn">Exportar Datos</button>
        </div>
        <input type="file" id="fileInput" accept=".json" style="display: none;">
    </div>

    <div class="container-box">
        <h3>Generar Informe de Supervisor</h3>
        <div class="report-controls">
            <div class="control-group">
                <label>Informe del 15 de:</label>
                <select id="reportMonth"></select>
                <input type="number" id="reportYear">
            </div>
            <div class="control-group">
                <label>al 15 del mes siguiente</label>
            </div>
        </div>
        <button id="generateReportBtn">Generar y Copiar Informe</button>
        <div class="report-output" id="reportOutput">El informe para WhatsApp aparecerá aquí...</div>
    </div>
    
    <div class="container-box" id="stats-section">
        <div class="stats-header" id="statsHeader">
            <h3>Estadísticas de Trabajo</h3>
            <span class="toggle-icon">+</span>
        </div>
        <div class="stats-content" id="statsContent">
            <div class="stats-controls">
                <label for="statsYear">Seleccionar Año:</label>
                <select id="statsYear"></select>
            </div>
            <div id="stats-results"></div>
        </div>
    </div>

    <div id="note-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-date"></h3>
            <div id="modal-status"></div>
            <textarea id="modal-note" placeholder="Añade una nota para este día..."></textarea>
            <div class="modal-buttons">
                <button id="modal-cancel">Cancelar</button>
                <button id="modal-save">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // --- Elementos del DOM ---
        const calendarGrid = document.getElementById('calendarGrid');
        const monthYearLabel = document.getElementById('monthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const themeToggleBtn = document.getElementById('themeToggle');
        const supervisorCounter = document.getElementById('supervisor-counter');
        const importDataBtn = document.getElementById('importDataBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const fileInput = document.getElementById('fileInput');
        
        // Reporte
        const generateReportBtn = document.getElementById('generateReportBtn');
        const reportOutput = document.getElementById('reportOutput');
        const reportMonthSelect = document.getElementById('reportMonth');
        const reportYearInput = document.getElementById('reportYear');
        
        // Estadísticas
        const statsHeader = document.getElementById('statsHeader');
        const statsContent = document.getElementById('statsContent');
        const statsToggleIcon = statsHeader.querySelector('.toggle-icon');
        const statsYearSelect = document.getElementById('statsYear');
        const statsResults = document.getElementById('stats-results');
        
        // Modal
        const noteModal = document.getElementById('note-modal');
        const modalDate = document.getElementById('modal-date');
        const modalStatus = document.getElementById('modal-status');
        const modalNote = document.getElementById('modal-note');
        const modalSaveBtn = document.getElementById('modal-save');
        const modalCancelBtn = document.getElementById('modal-cancel');

        // --- Estado de la Aplicación ---
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        
        // MODIFICADO: Solo Supervisor y Libre
        const statuses = ["Libre", "Supervisor"]; 
        const statusClassMap = { "Libre": "status-libre", "Supervisor": "status-supervisor", "Crupier": "status-crupier" }; // Mantenemos Crupier por retrocompatibilidad
        
        let workDays = JSON.parse(localStorage.getItem('workDays')) || {};
        let workNotes = JSON.parse(localStorage.getItem('workNotes')) || {};
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        let currentlyEditingDateKey = null;

        // --- FUNCIONES PRINCIPALES ---

        function renderCalendar() {
            calendarGrid.innerHTML = '';
            monthYearLabel.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            let firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const firstDayAdjusted = (firstDay === 0) ? 6 : firstDay - 1;
            const today = new Date();
            let supervisorCount = 0;

            for (let i = 0; i < firstDayAdjusted; i++) {
                calendarGrid.insertAdjacentHTML('beforeend', '<div class="day empty"></div>');
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const status = workDays[dateKey] || "Libre";
                if (status === 'Supervisor') supervisorCount++;
                const note = workNotes[dateKey] || "";

                const dayDiv = document.createElement('div');
                // Si un día antiguo era 'Crupier', muéstralo como libre
                const displayStatus = statuses.includes(status) ? status : "Libre";
                dayDiv.className = `day ${statusClassMap[displayStatus]}`;

                if (note) dayDiv.classList.add('has-note');
                if (today.getFullYear() === currentYear && today.getMonth() === currentMonth && today.getDate() === day) {
                    dayDiv.classList.add('today');
                }
                dayDiv.dataset.date = dateKey;
                dayDiv.innerHTML = `
                    <div class="day-content">
                        <span class="day-number">${day}</span>
                        <span class="status-text">${displayStatus === "Libre" ? "" : displayStatus}</span>
                    </div>
                    <div class="note-indicator"></div>`;
                dayDiv.addEventListener('click', () => openModal(dateKey));
                calendarGrid.appendChild(dayDiv);
            }
            supervisorCounter.textContent = `Días de Supervisor este mes: ${supervisorCount}`;
            if(statsContent.classList.contains('expanded')) generateAndShowStats();
        }

        // --- Lógica del Modal de Notas ---
        function openModal(dateKey) {
            currentlyEditingDateKey = dateKey;
            let status = workDays[dateKey] || "Libre";
            // Si el estado es uno antiguo como "Crupier", trátalo como "Libre" en el modal
            if (!statuses.includes(status)) {
                status = "Libre";
            }
            const note = workNotes[dateKey] || "";
            const [year, month, day] = dateKey.split('-');
            modalDate.textContent = `${day} de ${monthNames[parseInt(month) - 1]} de ${year}`;
            modalStatus.textContent = status;
            modalStatus.className = statusClassMap[status];
            modalStatus.dataset.status = status;
            modalNote.value = note;
            noteModal.classList.add('show');
        }
        function closeModal() {
            noteModal.classList.remove('show');
            currentlyEditingDateKey = null;
        }
        function changeModalStatus() {
            let currentStatus = modalStatus.dataset.status;
            const nextIndex = (statuses.indexOf(currentStatus) + 1) % statuses.length;
            const newStatus = statuses[nextIndex];
            modalStatus.textContent = newStatus;
            modalStatus.className = statusClassMap[newStatus];
            modalStatus.dataset.status = newStatus;
        }
        function saveDataFromModal() {
            if (!currentlyEditingDateKey) return;
            const newStatus = modalStatus.dataset.status;
            const newNote = modalNote.value.trim();
            workDays[currentlyEditingDateKey] = newStatus;
            if (newNote) {
                workNotes[currentlyEditingDateKey] = newNote;
            } else {
                delete workNotes[currentlyEditingDateKey];
            }
            localStorage.setItem('workDays', JSON.stringify(workDays));
            localStorage.setItem('workNotes', JSON.stringify(workNotes));
            showToast('Día guardado correctamente.');
            closeModal();
            renderCalendar();
        }

        // --- Lógica de Informe de WhatsApp ---
        function initializeReportControls() {
            reportMonthSelect.innerHTML = monthNames.map((name, index) => `<option value="${index}">${name}</option>`).join('');
            const now = new Date();
            reportMonthSelect.value = localStorage.getItem('reportMonth') || now.getMonth();
            reportYearInput.value = localStorage.getItem('reportYear') || now.getFullYear();
            reportMonthSelect.addEventListener('change', () => localStorage.setItem('reportMonth', reportMonthSelect.value));
            reportYearInput.addEventListener('change', () => localStorage.setItem('reportYear', reportYearInput.value));
        }

        function copyTextToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Informe copiado al portapapeles. ¡Listo!');
            }).catch(err => {
                showToast('Error al copiar el texto.', 4000);
            });
        }

        function generateReport() {
            const reportMonth = parseInt(reportMonthSelect.value);
            const reportYear = parseInt(reportYearInput.value);
            let startDate = new Date(reportYear, reportMonth, 15);
            let endDate = new Date(reportYear, reportMonth + 1, 15);
            let supervisorDays = [];
            
            for (let d = new Date(startDate); d < endDate; d.setDate(d.getDate() + 1)) {
                const dateKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                if (workDays[dateKey] === "Supervisor") {
                    const formattedDate = `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`;
                    supervisorDays.push(formattedDate);
                }
            }
            
            const startMonthName = monthNames[startDate.getMonth()];
            const endMonthName = monthNames[endDate.getMonth()];
            
            let reportText = `*Informe de días de Supervisor*\n`;
            reportText += `Del 15 de ${startMonthName} ${startDate.getFullYear()} al 15 de ${endMonthName} ${endDate.getFullYear()}\n\n`;
            reportText += `*Cantidad de días: ${supervisorDays.length}*\n`;
            reportText += "--------------------------------------\n";
            reportText += supervisorDays.length > 0 ? supervisorDays.map(day => `- ${day}`).join('\n') : "No se registraron días de Supervisor.";
            reportText += "\n--------------------------------------";
            
            reportOutput.textContent = reportText;
            copyTextToClipboard(reportText);
        }

        // --- Lógica de Estadísticas ---
        function toggleStatsVisibility() {
            statsContent.classList.toggle('expanded');
            if (statsContent.classList.contains('expanded')) {
                statsToggleIcon.textContent = '-';
                generateAndShowStats();
            } else {
                statsToggleIcon.textContent = '+';
            }
        }
        function populateYearSelector() {
            const currentYearValue = new Date().getFullYear();
            statsYearSelect.innerHTML = '';
            for (let year = currentYearValue - 5; year <= currentYearValue + 5; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYearValue) option.selected = true;
                statsYearSelect.appendChild(option);
            }
        }
        
        // MODIFICADO: Solo cuenta días de Supervisor
        function generateAndShowStats() {
            const year = parseInt(statsYearSelect.value);
            if (isNaN(year)) return;

            let yearTotalSupervisor = 0;
            let periodResults = [];

            // Calcular total anual
            const yearStartDate = new Date(year, 0, 1);
            const yearEndDate = new Date(year, 11, 31);
            for (let d = yearStartDate; d <= yearEndDate; d.setDate(d.getDate() + 1)) {
                const dateKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                if (workDays[dateKey] === 'Supervisor') {
                    yearTotalSupervisor++;
                }
            }

            // Calcular por período
            for (let month = 0; month < 12; month++) {
                let periodSupervisorCount = 0;
                let startDate = new Date(year, month, 15);
                let endDate = new Date(year, month + 1, 15);
                
                for (let d = new Date(startDate); d < endDate; d.setDate(d.getDate() + 1)) {
                    const dateKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    if (workDays[dateKey] === 'Supervisor') {
                        periodSupervisorCount++;
                    }
                }
                const periodName = `${monthNames[month].substring(0,3)} a ${monthNames[endDate.getMonth()].substring(0,3)}`;
                periodResults.push({ name: periodName, count: periodSupervisorCount });
            }

            let tableHTML = `
                <table>
                    <thead><tr><th>Período</th><th>Días de Supervisor</th></tr></thead>
                    <tbody>
                        <tr class="total-row"><td>Total ${year}</td><td>${yearTotalSupervisor}</td></tr>`;
            periodResults.forEach(p => {
                tableHTML += `<tr><td>${p.name}</td><td>${p.count}</td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            statsResults.innerHTML = tableHTML;
        }

        // --- Navegación y Animación ---
        function changeMonth(offset) {
            calendarGrid.style.opacity = '0';
            setTimeout(() => {
                currentMonth += offset;
                if (currentMonth < 0) { currentMonth = 11; currentYear--; } 
                else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                renderCalendar();
                calendarGrid.style.opacity = '1';
            }, 200);
        }

        // --- Funciones Auxiliares (Toast, Import/Export) ---
        function showToast(message, duration = 4000) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }
        function exportData() {
            const dataToExport = { workDays, workNotes };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'calendario-trabajo-backup.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Datos exportados correctamente.');
        }
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.workDays && typeof imported.workDays === 'object') {
                        workDays = imported.workDays;
                        workNotes = imported.workNotes || {};
                        localStorage.setItem('workDays', JSON.stringify(workDays));
                        localStorage.setItem('workNotes', JSON.stringify(workNotes));
                        renderCalendar();
                        showToast('¡Datos importados con éxito!');
                    } else { throw new Error('Formato de workDays inválido.'); }
                } catch (error) { showToast('Error: El archivo no es válido.'); } 
                finally { fileInput.value = ''; }
            };
            reader.readAsText(file);
        }
        
        // --- MANEJADORES DE EVENTOS ---
        prevMonthBtn.addEventListener('click', () => changeMonth(-1));
        nextMonthBtn.addEventListener('click', () => changeMonth(1));
        themeToggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            themeToggleBtn.textContent = isDarkMode ? '☀️' : '🌙';
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        });
        exportDataBtn.addEventListener('click', exportData);
        importDataBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', importData);
        generateReportBtn.addEventListener('click', generateReport);
        statsHeader.addEventListener('click', toggleStatsVisibility);
        modalStatus.addEventListener('click', changeModalStatus);
        modalSaveBtn.addEventListener('click', saveDataFromModal);
        modalCancelBtn.addEventListener('click', closeModal);
        noteModal.addEventListener('click', (e) => { if (e.target === noteModal) closeModal(); });
        statsYearSelect.addEventListener('change', generateAndShowStats);

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggleBtn.textContent = '☀️';
            } else {
                themeToggleBtn.textContent = '🌙';
            }
            initializeReportControls();
            populateYearSelector();
            renderCalendar();
        });
    </script>
</body>
</html>
